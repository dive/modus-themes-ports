name: Check Upstream Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9:00 UTC
  workflow_dispatch:

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    env:
      GH_REPO: ${{ github.repository }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for upstream updates
        id: check
        run: |
          UPSTREAM_REPO="https://github.com/protesilaos/modus-themes"
          SUBTREE_PREFIX="vendor/modus-themes"

          # Get current subtree commit from the last squash merge message
          # Format: "Squashed 'vendor/modus-themes/' changes from abc1234..def5678"
          CURRENT_COMMIT=$(git log --all --grep="Squashed '$SUBTREE_PREFIX/'" --format=%s | head -1 | grep -oE '[a-f0-9]{7,40}$' || echo "")
          
          if [ -z "$CURRENT_COMMIT" ]; then
            echo "âŒ Could not find subtree commit hash in git history"
            echo "needs_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "current=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Current subtree commit: $CURRENT_COMMIT"

          # Fetch upstream with enough depth to find our current commit
          git remote add upstream "$UPSTREAM_REPO" 2>/dev/null || true
          git fetch upstream main --depth=200

          # Get latest upstream commit
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          UPSTREAM_SHORT="${UPSTREAM_COMMIT:0:7}"

          echo "upstream=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "upstream_short=$UPSTREAM_SHORT" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Upstream HEAD: $UPSTREAM_SHORT"

          # Check if current subtree commit exists in upstream history
          if ! git cat-file -e "$CURRENT_COMMIT" 2>/dev/null; then
            echo "âš ï¸ Current commit not in fetched history, fetching more..."
            git fetch upstream main --unshallow 2>/dev/null || git fetch upstream main --depth=500
          fi

          # Compare within upstream's history: count commits from our subtree commit to upstream HEAD
          if git merge-base --is-ancestor "$CURRENT_COMMIT" upstream/main 2>/dev/null; then
            COMMITS_BEHIND=$(git rev-list --count "$CURRENT_COMMIT"..upstream/main 2>/dev/null || echo "unknown")
            
            if [ "$COMMITS_BEHIND" = "0" ]; then
              echo "needs_update=false" >> $GITHUB_OUTPUT
              echo "âœ… Subtree is up to date with upstream"
            else
              echo "needs_update=true" >> $GITHUB_OUTPUT
              echo "behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
              echo "âš ï¸ Subtree is behind upstream by $COMMITS_BEHIND commits"
              
              # Get recent upstream commits for the issue
              RECENT_COMMITS=$(git log "$CURRENT_COMMIT"..upstream/main --oneline -10 2>/dev/null || echo "Unable to fetch commits")
              echo "recent_commits<<EOF" >> $GITHUB_OUTPUT
              echo "$RECENT_COMMITS" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Could not verify commit ancestry (history may have been rewritten)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "behind=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Ensure upstream-update label
        if: steps.check.outputs.needs_update == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh label list --json name --jq '.[] | select(.name=="upstream-update")' | grep -q .; then
            gh label create "upstream-update" \
              --color "0e8a16" \
              --description "Upstream vendor update"
          fi

      - name: Check for existing issue
        if: steps.check.outputs.needs_update == 'true'
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh issue list --label "upstream-update" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "issue_exists=true" >> $GITHUB_OUTPUT
            echo "issue_number=$EXISTING" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Issue #$EXISTING already exists"
          else
            echo "issue_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create update issue
        if: steps.check.outputs.needs_update == 'true' && steps.existing.outputs.issue_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Update vendor/modus-themes to upstream (${{ steps.check.outputs.upstream_short }})" \
            --label "upstream-update" \
            --body "## Upstream Update Available

          The [modus-themes](https://github.com/protesilaos/modus-themes) upstream repository has new commits.

          **Upstream HEAD:** \`${{ steps.check.outputs.upstream }}\`

          ### How to Update

          Run the update command:

          \`\`\`sh
          python3 scripts/modus.py update-subtree
          \`\`\`

          This will:
          1. Pull the latest changes from upstream via git subtree
          2. Regenerate palettes from the updated source
          3. Re-render all themes

          After updating, verify the changes:

          \`\`\`sh
          python3 scripts/modus.py validate --tool all
          \`\`\`

          ---
          *This issue was automatically created by the upstream check workflow.*"
